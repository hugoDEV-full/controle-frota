<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Editar Motorista</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery e jquery-mask -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2>Editar Motorista</h2>
    <a href="/motoristas" class="btn btn-secondary mb-3">&larr; Voltar</a>

    <!--  exibirá 3 tipos de alertas (info / success / danger) -->
    <div id="feedback" class="mt-3" style="display:none;"></div>

    <form id="formEdit" enctype="multipart/form-data" novalidate>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" id="motoristaId" value="<%= motorista.id %>">

      <!-- Campos… -->
      <!-- Nome -->
      <div class="mb-3">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" class="form-control" id="nome" name="nome" value="<%= motorista.nome %>" required>
      </div>
      <!-- CPF -->
      <div class="mb-3">
        <label for="cpf" class="form-label">CPF</label>
        <input type="text" class="form-control" id="cpf" name="cpf" value="<%= motorista.cpf %>" required>
      </div>
      <!-- CNH -->
      <div class="mb-3">
        <label for="cnh" class="form-label">CNH</label>
        <input type="text" class="form-control" id="cnh" name="cnh" value="<%= motorista.cnh %>" required>
      </div>
      <!-- Data Validade -->
      <div class="mb-3">
        <label for="dataValidade" class="form-label">Data de Validade</label>
        <input
          type="date"
          class="form-control"
          id="dataValidade"
          name="dataValidade"
          value="<%= motorista.data_validade.toISOString().slice(0,10) %>"
          required
        >
      </div>
      <!-- Categoria -->
      <div class="mb-3">
        <label for="categoria" class="form-label">Categoria</label>
        <select class="form-select" id="categoria" name="categoria" required>
          <% ['A','B','C','D','E'].forEach(cat => { %>
            <option value="<%= cat %>" <%= motorista.categoria===cat?'selected':'' %>><%= cat %></option>
          <% }) %>
        </select>
      </div>
      <!-- Foto -->
      <div class="mb-3">
        <label for="foto" class="form-label">Foto do Motorista</label>
        <% if (motorista.foto) { %>
          <div class="mb-2">
            <a href="/uploads/<%= motorista.foto %>" target="_blank">
              <img src="/uploads/<%= motorista.foto %>" class="img-thumbnail" style="max-width:150px;">
            </a>
          </div>
        <% } %>
        <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
      </div>

      <!-- Botões -->
      <button id="btnSave" type="submit" class="btn btn-primary">Salvar Alterações</button>
      <button id="btnDelete" type="button" class="btn btn-danger ms-2">Excluir Motorista</button>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    $(function(){
      $('#cpf').mask('000.000.000-00', {reverse:true});
      $('#cnh').mask('00000000000');

      // --- SALVAR EDIÇÃO (PUT) ---
      $('#formEdit').on('submit', async function(e){
        e.preventDefault();
        const id = $('#motoristaId').val();
        const formData = new FormData(this);
        const fb = $('#feedback');

        // alerta 1: início do processamento
        fb.removeClass().addClass('alert alert-info').text('Salvando alterações...').show();

        try {
          const res = await fetch(`/api/editar-motorista/${id}`, {
            method: 'PUT',
            headers: { 'CSRF-Token': $('input[name="_csrf"]').val() },
            body: formData
          });
          const data = await res.json();
          // alerta 2: sucesso ou erro
          fb
            .removeClass()
            .addClass('alert ' + (data.success ? 'alert-success' : 'alert-danger'))
            .text(data.message);
          if (data.success) setTimeout(() => location.href = '/motoristas', 1500);
        } catch (err) {
          fb.removeClass().addClass('alert alert-danger').text('Erro de comunicação ao salvar.').show();
        }
      });

   
    // --- EXCLUIR MOTORISTA (DELETE) ---
    $('#btnDelete').on('click', async function(){
      const id = $('#motoristaId').val();
      const fb = $('#feedback');

      // 1ª confirmação
      if (!confirm('Você tem certeza que deseja excluir este motorista?')) {
        return;
      }
      // 2ª confirmação
      if (!confirm('Esta ação é irreversível! Deseja continuar?')) {
        return;
      }
      // 3ª confirmação
      if (!confirm('Última chance: realmente deseja excluir este motorista e todos os dados associados?')) {
        return;
      }

      // alerta/info antes de enviar
      fb.removeClass().addClass('alert alert-info').text('Excluindo motorista...').show();

      try {
        const res = await fetch(`/api/deletar-motorista/${id}`, {
          method: 'DELETE',
          headers: { 'CSRF-Token': $('input[name="_csrf"]').val() }
        });
        const data = await res.json();
        fb
          .removeClass()
          .addClass('alert ' + (data.success ? 'alert-success' : 'alert-danger'))
          .text(data.message);
        if (data.success) setTimeout(() => location.href = '/motoristas', 1500);
      } catch (err) {
        fb.removeClass().addClass('alert alert-danger').text('Erro de comunicação ao excluir.').show();
      }
    });
  });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
