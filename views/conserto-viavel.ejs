<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="<%= csrfToken %>">
  <title>Conserto Viável</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .scroll-horizontal {
      overflow-y: auto;
      /* Define a altura máxima para forçar o scroll vertical se necessário */
      max-height: 500px;
    }
  </style>
</head>
<body>
  <div class="container-fluid my-4">
    <h1 class="mb-4">Sistema de Pesquisa FIPE e Relatório viabilidade de conserto</h1>
    <div class="row">
      <!-- Pesquisa -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            Pesquisar Conserto
          </div>
          <div class="card-body">
            <form id="formConserto">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <div class="mb-3">
                <label for="marca" class="form-label">Marca</label>
                <select id="marca" class="form-select" required>
                  <option value="">Carregando marcas...</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="modelo" class="form-label">Modelo</label>
                <select id="modelo" class="form-select" required>
                  <option value="">Selecione a marca primeiro</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="ano" class="form-label">Ano</label>
                <select id="ano" class="form-select" required>
                  <option value="">Selecione o modelo primeiro</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="custo_conserto" class="form-label">
                  Custo do Conserto (R$)
                </label>
                <input type="number" step="0.01" id="custo_conserto" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-success w-100">
                Avaliar Conserto
              </button>
            </form>
            <div id="resultado" class="mt-3"></div>
          </div>
        </div>
      </div>
      <!-- Relatório -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white">
            Relatório de Pesquisas
          </div>
          <div class="card-body scroll-horizontal">
            <% if (registros && registros.length) { %>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Marca Código</th>
                      <th>Marca Nome</th>
                      <th>Modelo</th>
                      <th>Modelo (Código – Nome)</th>
                      <th>Ano</th>
                      <th>Valor FIPE</th>
                      <th>Custo</th>
                      <th>Viável?</th>
                      <th>Data</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% registros.forEach(reg => { %>
                      <tr id="linha-<%= reg.id %>">
                        <td><%= reg.id %></td>
                        <td><%= reg.marca %></td>
                        <td><%= reg.marca_nome %></td>
                        <td><%= reg.modelo %></td>
                        <td><%= reg.modelo %> – <%= reg.modelo_nome %></td>
                        <td><%= reg.ano %></td>
                        <td>R$ <%= parseFloat(reg.valor_fipe).toFixed(2) %></td>
                        <td>R$ <%= parseFloat(reg.custo_conserto).toFixed(2) %></td>
                        <td>
                          <% if (reg.conserto_viavel) { %>
                            <span class="badge bg-success">Sim</span>
                          <% } else { %>
                            <span class="badge bg-danger">Não</span>
                          <% } %>
                        </td>
                        <td><%= new Date(reg.dataCadastro).toLocaleString() %></td>
                        <td>
                          <button class="btn btn-danger btn-sm" onclick="confirmarExclusao(<%= reg.id %>)">
                            Excluir
                          </button>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <p class="text-muted">Nenhum registro encontrado.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Função para confirmar e executar a exclusão do registro
    function confirmarExclusao(id) {
      if (confirm("Você tem certeza que deseja excluir este registro?")) {
        fetch(`/excluir-avaliacao/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken  }
        })
        .then(response => response.json())
        .then(data => {
          if (data.sucesso) {
            alert(data.mensagem);
            // Remove a linha da tabela sem recarregar a página
            const linha = document.getElementById('linha-' + id);
            if (linha) {
              linha.remove();
            }
          } else {
            alert("Erro ao excluir: " + data.error);
          }
        })
        .catch(error => {
          console.error("Erro na requisição de exclusão:", error);
          alert("Erro ao excluir registro.");
        });
      }
    }
  </script>

  <script>
    // Funções para carregar marcas, modelos e anos conforme estava anteriormente

    async function carregarMarcas() {
      const sel = document.getElementById('marca');
      sel.innerHTML = '<option value="">Selecione a marca</option>';
      try {
        const res = await fetch('/api/marcas');
        const json = await res.json();
        json.marcas.forEach(m => {
          sel.innerHTML += `<option value="${m.codigo}">${m.nome}</option>`;
        });
      } catch {
        sel.innerHTML = '<option value="">Erro ao carregar marcas</option>';
      }
    }

    async function carregarModelos() {
      const marca = document.getElementById('marca').value;
      const sel = document.getElementById('modelo');
      sel.innerHTML = '<option>Carregando…</option>';
      document.getElementById('ano').innerHTML =
        '<option>Selecione o modelo primeiro</option>';
      if (!marca) return (sel.innerHTML = '<option>Selecione a marca</option>');
      try {
        const res = await fetch(`/api/modelos?marca=${marca}`);
        const json = await res.json();
        sel.innerHTML = '<option value="">Selecione o modelo</option>';
        json.modelos.forEach(mo => {
          sel.innerHTML += `<option value="${mo.codigo}">${mo.nome}</option>`;
        });
      } catch {
        sel.innerHTML = '<option>Erro ao carregar</option>';
      }
    }


    async function carregarAnos() {
      const marca = document.getElementById('marca').value;
      const modelo = document.getElementById('modelo').value;
      const sel = document.getElementById('ano');
      sel.innerHTML = '<option>Carregando…</option>';
      if (!marca || !modelo)
        return (sel.innerHTML = '<option>Selecione o modelo</option>');
      try {
        const res = await fetch(`/api/anos?marca=${marca}&modelo=${modelo}`);
        const json = await res.json();
        sel.innerHTML = '<option value="">Selecione o ano</option>';
        json.anos.forEach(a => {
          sel.innerHTML += `<option value="${a.codigo}">${a.nome}</option>`;
        });
      } catch {
        sel.innerHTML = '<option>Erro ao carregar</option>';
      }
    }

    document.getElementById('formConserto').addEventListener('submit', async e => {
      e.preventDefault();
      const marca = document.getElementById('marca').value;
      const modelo = document.getElementById('modelo').value;
      const ano = document.getElementById('ano').value;
      const custo = document.getElementById('custo_conserto').value;

      const res = await fetch('/conserto-viavel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken  },
        body: JSON.stringify({ marca, modelo, ano, custo_conserto: custo })
      });
      const json = await res.json();
      const out = document.getElementById('resultado');
      if (!json.sucesso) {
        return (out.innerHTML = `<div class="alert alert-danger">${json.error}</div>`);
      }

      const marcaSelect = document.getElementById('marca');
      const marcaCodigo = marcaSelect.value.trim();

      // Validação para garantir que uma marca foi selecionada
      if (!marcaCodigo) {
        alert("Por favor, selecione uma marca válida.");
        return;
      }

      const marcaNome = marcaSelect.selectedOptions[0].text.trim();

      const avaliacaoDados = {
        marca: marcaCodigo,
        marca_nome: marcaNome,
        modelo: document.getElementById('modelo').value,
        modelo_nome: document.getElementById('modelo').selectedOptions[0].text,
        ano: json.ano_numero,
        valor_fipe: json.valor_fipe,
        custo_conserto: document.getElementById('custo_conserto').value,
        conserto_viavel: json.conserto_viavel
      };

      out.innerHTML = `
        <p>Valor FIPE: R$ ${json.valor_fipe.toFixed(2)}</p>
        <p>Custo representa ${json.percentual_custo.toFixed(2)}%</p>
        <p>${json.mensagem}</p>
        <button id="btnSalvar" class="btn btn-primary btn-sm">
          Salvar Avaliação
        </button>
      `;
      document.getElementById('btnSalvar').addEventListener('click', async () => {
        const resp = await fetch('/salvar-avaliacao', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken  },
          body: JSON.stringify(avaliacaoDados)
        });
        const js = await resp.json();
        alert(js.sucesso ? js.mensagem : `Erro: ${js.error}`);
        if (js.sucesso) setTimeout(() => location.reload(), 800);
      });
    });

    window.onload = () => {
      carregarMarcas();
      document.getElementById('marca').addEventListener('change', carregarModelos);
      document.getElementById('modelo').addEventListener('change', carregarAnos);
    };
  </script>
</body>
</html>
