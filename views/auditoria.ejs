<div class="container py-4">
  <h1 class="mb-4">Logs de Auditoria</h1>

  <!-- Formulário de filtros -->
  <form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
      <input 
        type="text" 
        class="form-control" 
        name="usuario" 
        placeholder="Usuário" 
        value="<%= filtro?.usuario || '' %>"
        data-bs-toggle="tooltip"
        title="Filtrar apenas as ações executadas por este usuário (e-mail ou nome)"
      >
    </div>
    <div class="col-md-2">
      <input 
        type="date" 
        class="form-control" 
        name="data" 
        value="<%= filtro?.data || '' %>"
        data-bs-toggle="tooltip"
        title="Filtrar apenas as ações registradas nesta data (ano-mês-dia)"
      >
    </div>
    <div class="col-md-3">
      <input 
        type="text" 
        class="form-control" 
        name="rota" 
        placeholder="Rota" 
        value="<%= filtro?.rota || '' %>"
        data-bs-toggle="tooltip"
        title="Filtrar apenas as ações realizadas neste endpoint (ex.: /login)"
      >
    </div>
    <div class="col-md-2">
      <select 
        class="form-select" 
        name="metodo"
        data-bs-toggle="tooltip"
        title="Filtrar pelo tipo de operação: leitura, criação, edição, exclusão ou autenticação"
      >
        <option value="">Método</option>
        <% ['GET','POST','PUT','PATCH','DELETE','LOGIN','LOGOUT'].forEach(m => { %>
          <option 
            value="<%= m %>" 
            <%= filtro?.metodo === m ? 'selected' : '' %>
          ><%= m %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <button 
        type="submit" 
        class="btn btn-primary w-100"
        data-bs-toggle="tooltip"
        title="Aplicar filtros e refinar os registros exibidos"
      >
        Filtrar
      </button>
    </div>
  </form>

  <!-- Tabela de auditoria -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th data-bs-toggle="tooltip" title="Conta que executou a ação">Usuário</th>
          <th data-bs-toggle="tooltip" title="Caminho do recurso acessado ou alterado">Rota</th>
          <th data-bs-toggle="tooltip" title="Tipo de operação realizada pelo usuário">Método</th>
          <th data-bs-toggle="tooltip" title="Data e hora em que a ação foi gravada">Data/Hora</th>
          <th data-bs-toggle="tooltip" title="Dados enviados ou descrição da ação">Detalhes</th>
        </tr>
      </thead>
      <tbody>
        <% logs.forEach(log => { %>
          <tr>
            <!-- Usuário -->
            <td data-bs-toggle="tooltip" title="Usuário: <%= log.usuario %>">
              <%= log.usuario %>
            </td>

            <!-- Rota -->
            <td data-bs-toggle="tooltip" title="Rota: <%= log.rota %>">
              <%= log.rota %>
            </td>

            <!-- Método -->
            <td>
              <% 
                let badge, tip;
                const rotaStr = (log.rota || '').toLowerCase();
                if (log.metodo === 'GET') {
                  badge = 'Visualização';        
                  tip   = 'Usuário visualizou dados';
                }
                else if (log.metodo === 'POST') {
                  if (rotaStr.includes('/delete') || rotaStr.includes('/excluir')) {
                    badge = 'Exclusão';            
                    tip   = 'Usuário excluiu um registro';
                  }
                  else if (rotaStr.includes('/edit') || rotaStr.includes('/update') || rotaStr.includes('/editar')) {
                    badge = 'Edição';              
                    tip   = 'Usuário editou um registro';
                  }
                  else {
                    badge = 'Criação';            
                    tip   = 'Usuário criou um novo registro';
                  }
                }
                else if (['PUT','PATCH'].includes(log.metodo)) {
                  badge = 'Edição';                
                  tip   = 'Usuário atualizou um registro';
                }
                else if (log.metodo === 'DELETE') {
                  badge = 'Exclusão';              
                  tip   = 'Usuário removeu um registro';
                }
                else if (log.metodo === 'LOGIN') {
                  badge = 'Login';                 
                  tip   = 'Usuário efetuou login';
                }
                else if (log.metodo === 'LOGOUT') {
                  badge = 'Logout';                
                  tip   = 'Usuário efetuou logout';
                }
                else {
                  badge = log.metodo;              
                  tip   = 'Ação especial ou personalizada';
                }
                const classes = {
                  GET:    'bg-info',
                  POST:   badge === 'Criação'    ? 'bg-success'
                         : badge === 'Edição'    ? 'bg-warning text-dark'
                         : badge === 'Exclusão'  ? 'bg-danger'
                         : 'bg-secondary',
                  PUT:    'bg-warning text-dark',
                  PATCH:  'bg-warning text-dark',
                  DELETE: 'bg-danger',
                  LOGIN:  'bg-primary',
                  LOGOUT: 'bg-secondary'
                }[log.metodo] || 'bg-dark';
              %>
              <span 
                class="badge <%= classes %>" 
                data-bs-toggle="tooltip" 
                title="<%= tip %>"
              ><%= badge %></span>
              <br>
              <small 
                class="text-muted"
                data-bs-toggle="tooltip"
                title="Método real usado"
              >(<%= log.metodo %>)</small>
            </td>

            <!-- Data/Hora -->
            <td data-bs-toggle="tooltip" title="Registrado em: <%= log.criado_em %>">
              <%= log.criado_em %>
            </td>

            <!-- Detalhes -->
            <td 
              style="max-width:300px; overflow:auto;"
              data-bs-toggle="tooltip"
              title="<%= log.detalhes.replace(/"/g, '&quot;') %>"
            >
              <% let parsed; %>
              <% try { parsed = JSON.parse(log.detalhes); } catch {} %>

              <% if (parsed && (parsed.body || parsed.query)) { %>
                <% if (parsed.body && Object.keys(parsed.body).length) { %>
                  <strong>Dados enviados (body):</strong>
                  <pre class="mb-1"><%= JSON.stringify(parsed.body, null, 2) %></pre>
                <% } %>
                <% if (parsed.query && Object.keys(parsed.query).length) { %>
                  <strong>Parâmetros (query):</strong>
                  <pre><%= JSON.stringify(parsed.query, null, 2) %></pre>
                <% } %>
                <% if ((!parsed.body || !Object.keys(parsed.body).length) 
                       && (!parsed.query || !Object.keys(parsed.query).length)) { %>
                  <em>Sem dados adicionais fornecidos</em>
                <% } %>
              <% } else { %>
                <%= log.detalhes %>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Inicializa todos os tooltips do Bootstrap
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el)
  });
</script>

