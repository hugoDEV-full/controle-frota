<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auditoria</title>

  
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- DataTables Bootstrap 5 CSS -->
  <link
    href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    rel="stylesheet"
  >
</head>
<body>
  <div class="container-fluid py-4">
    <h1 class="mb-4">Logs de Auditoria</h1>

    <!-- Formulário de filtros -->
    <form method="GET" class="row g-3 mb-4">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="col-md-3">
        <input type="text" name="usuario" class="form-control"
               placeholder="Usuário"
               value="<%= filtro.usuario || '' %>"
               data-bs-toggle="tooltip"
               title="Filtrar apenas as ações executadas por este usuário">
      </div>
      <div class="col-md-2">
        <input type="date" name="data" class="form-control"
               value="<%= filtro.data || '' %>"
               data-bs-toggle="tooltip"
               title="Filtrar pela data (ano-mês-dia)">
      </div>
      <div class="col-md-3">
        <input type="text" name="rota" class="form-control"
               placeholder="Rota"
               value="<%= filtro.rota || '' %>"
               data-bs-toggle="tooltip"
               title="Filtrar pelo endpoint">
      </div>
      <div class="col-md-2">
        <select name="metodo" class="form-select"
                data-bs-toggle="tooltip"
                title="Filtrar pelo método HTTP">
          <option value="">Método</option>
          <% ['GET','POST','PUT','PATCH','DELETE','LOGIN','LOGOUT'].forEach(m => { %>
            <option value="<%= m %>"
              <%= filtro.metodo === m ? 'selected' : '' %>>
              <%= m %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          Filtrar
        </button>
      </div>
    </form>

    <!-- Tabela de auditoria -->
    <div class="table-responsive">
      <table id="tabelaAuditoria"
             class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Usuário</th>
            <th>Rota</th>
            <th>Método</th>
            <th>Data/Hora</th>
            <th>Detalhes</th>
          </tr>
        </thead>
        <tbody>
          <% logs.forEach(log => { %>
            <tr>
              <td><%= log.usuario %></td>
              <td><%= log.rota %></td>
              <td>
                <% 
                  let badge, tip;
                  const rotaStr = (log.rota||'').toLowerCase();
                  if (log.metodo === 'GET') {
                    badge = 'Visualização'; tip = 'Visualizou dados';
                  }
                  else if (log.metodo === 'POST') {
                    if (rotaStr.includes('delete')||rotaStr.includes('excluir')) {
                      badge = 'Exclusão'; tip = 'Excluiu registro';
                    }
                    else if (rotaStr.includes('edit')||rotaStr.includes('update')||rotaStr.includes('editar')) {
                      badge = 'Edição'; tip = 'Editou registro';
                    }
                    else {
                      badge = 'Criação'; tip = 'Criou registro';
                    }
                  }
                  else if (['PUT','PATCH'].includes(log.metodo)) {
                    badge = 'Edição'; tip = 'Atualizou registro';
                  }
                  else if (log.metodo === 'DELETE') {
                    badge = 'Exclusão'; tip = 'Removeu registro';
                  }
                  else if (log.metodo === 'LOGIN') {
                    badge = 'Login'; tip = 'Efetuou login';
                  }
                  else if (log.metodo === 'LOGOUT') {
                    badge = 'Logout'; tip = 'Efetuou logout';
                  }
                  else {
                    badge = log.metodo; tip = 'Ação personalizada';
                  }
                  const classes = {
                    GET:    'bg-info',
                    POST:   badge==='Criação'?'bg-success'
                           : badge==='Edição'?'bg-warning text-dark'
                           : badge==='Exclusão'?'bg-danger'
                           : 'bg-secondary',
                    PUT:    'bg-warning text-dark',
                    PATCH:  'bg-warning text-dark',
                    DELETE: 'bg-danger',
                    LOGIN:  'bg-primary',
                    LOGOUT: 'bg-secondary'
                  }[log.metodo] || 'bg-dark';
                %>
                <span class="badge <%= classes %>"
                      data-bs-toggle="tooltip"
                      title="<%= tip %>">
                  <%= badge %>
                </span>
                <br>
                <small class="text-muted"
                       data-bs-toggle="tooltip"
                       title="Método real">
                  (<%= log.metodo %>)
                </small>
              </td>
              <td><%= log.criado_em %></td>
              <td style="max-width:300px; overflow:auto;"
                  data-bs-toggle="tooltip"
                  title="<%= log.detalhes.replace(/"/g,'&quot;') %>">
                <% let parsed; try { parsed = JSON.parse(log.detalhes); } catch{} %>
                <% if (parsed && (parsed.body||parsed.query)) { %>
                  <% if (parsed.body && Object.keys(parsed.body).length) { %>
                    <strong>Body:</strong>
                    <pre><%= JSON.stringify(parsed.body,null,2) %></pre>
                  <% } %>
                  <% if (parsed.query && Object.keys(parsed.query).length) { %>
                    <strong>Query:</strong>
                    <pre><%= JSON.stringify(parsed.query,null,2) %></pre>
                  <% } %>
                  <% if ((!parsed.body||!Object.keys(parsed.body).length)
                         && (!parsed.query||!Object.keys(parsed.query).length)) { %>
                    <em>Sem dados adicionais</em>
                  <% } %>
                <% } else { %>
                  <%= log.detalhes %>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- jQuery (DataTables ) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap 5 Bundle (Popper + JS) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  ></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // Inicializa tooltips Bootstrap
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });

    // Inicializa DataTables
    $(document).ready(() => {
      $('#tabelaAuditoria').DataTable({
        lengthMenu: [
          [10, 25, 50, 100, 1000, -1],
          [10, 25, 50, 100, 1000, "Todos"]
        ],
        pageLength: 10,
        order: [[3, 'desc']],  // ordena pela coluna Data/Hora
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
        }
      });
    });
  </script>
</body>
</html>
