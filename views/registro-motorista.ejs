<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Motoristas</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery e jQuery Mask Plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <% if (typeof errorMessage !== 'undefined') { %>
      <div class="alert alert-danger">
        <%= errorMessage %>
      </div>
    <% } %>

    <% if (isMotorista) { %>
      <div class="alert alert-info">
        Você já está cadastrado como motorista!
        <br>
        Nome: <strong><%= motorista.nome %></strong><br>
        CNH: <strong><%= motorista.cnh %></strong><br>
      </div>
    <% } else { %>
      <% if (errors && errors.length) { %>
        <div class="alert alert-danger">
          <ul class="mb-0">
            <% errors.forEach(err => { %>
              <li><%= err.msg %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <h1 class="mb-4">Cadastro de Motoristas</h1>

      <form id="formCadastro" action="/cadastrar-motorista" method="POST" enctype="multipart/form-data" novalidate>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="mb-3">
          <label for="nome" class="form-label">Nome:</label>
          <input
            type="text"
            class="form-control <%= errorFields.includes('nome') ? 'is-invalid' : '' %>"
            id="nome"
            name="nome"
            required
            value="<%= data.nome || '' %>"
          >
          <div class="invalid-feedback">Por favor, informe o nome.</div>
        </div>

        <div class="mb-3">
          <label for="cpf" class="form-label">CPF:</label>
          <input
            type="text"
            class="form-control <%= errorFields.includes('cpf') ? 'is-invalid' : '' %>"
            id="cpf"
            name="cpf"
            required
            pattern="\d{11}"
            title="Apenas números, 11 dígitos"
            value="<%= data.cpf || '' %>"
          >
          <div class="invalid-feedback">Digite um CPF válido (11 números).</div>
        </div>

        <div class="mb-3">
          <label for="cnh" class="form-label">Número da CNH:</label>
          <input
            type="text"
            class="form-control <%= errorFields.includes('cnh') ? 'is-invalid' : '' %>"
            id="cnh"
            name="cnh"
            required
            pattern="\d{9}"
            title="Apenas números, 9 dígitos"
            value="<%= data.cnh || '' %>"
          >
          <div class="invalid-feedback">Digite um número de CNH válido (9 números).</div>
        </div>

        <div class="mb-3">
          <label for="dataValidade" class="form-label">Data de Validade da CNH:</label>
          <input
            type="date"
            class="form-control <%= errorFields.includes('dataValidade') ? 'is-invalid' : '' %>"
            id="dataValidade"
            name="dataValidade"
            required
            value="<%= data.dataValidade || '' %>"
          >
          <div class="invalid-feedback">Por favor, informe a data de validade.</div>
        </div>

        <div class="mb-3">
          <label for="categoria" class="form-label">Categoria da CNH:</label>
          <select
            class="form-select <%= errorFields.includes('categoria') ? 'is-invalid' : '' %>"
            id="categoria"
            name="categoria"
            required
          >
            <option value="">Selecione...</option>
            <% ['A','B','C','D','E'].forEach(cat => { %>
              <option value="<%= cat %>" <%= data.categoria === cat ? 'selected' : '' %>><%= cat %></option>
            <% }) %>
          </select>
          <div class="invalid-feedback">Escolha uma categoria.</div>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email:</label>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            readonly
            value="<%= user.email %>"
          >
        </div>

        <div class="mb-3">
          <label for="foto" class="form-label">Foto:</label>
          <input
            type="file"
            class="form-control <%= errorFields.includes('foto') ? 'is-invalid' : '' %>"
            id="foto"
            name="foto"
            accept="image/*"
            required
          >
          <div class="invalid-feedback">Envie uma foto válida.</div>
        </div>

        <button type="submit" class="btn btn-primary">Cadastrar</button>
      </form>

      <script>
        // Bootstrap custom validation
        (() => {
          'use strict';
          const form = document.getElementById('formCadastro');
          form.addEventListener('submit', e => {
            if (!form.checkValidity()) {
              e.preventDefault();
              e.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        })();
      </script>

      <!-- Área de feedback visual -->
      <div id="feedback" class="mt-3" style="display:none;"></div>

      <script>
        // Aplica a máscara no CPF
        $(document).ready(function(){
          $('#cpf').mask('000.000.000-00');
        });

        // Função para exibir mensagens de feedback usando alertas do Bootstrap
        function exibirFeedback(mensagem, tipo) {
          const feedbackEl = document.getElementById('feedback');
          feedbackEl.className = '';
          feedbackEl.classList.add('alert', tipo === 'success' ? 'alert-success' : 'alert-danger');
          feedbackEl.textContent = mensagem;
          feedbackEl.style.display = 'block';
          setTimeout(() => { feedbackEl.style.display = 'none'; }, 5000);
        }

        // Envio do formulário via AJAX
        document.getElementById('formCadastro').addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(this);

          try {
            const response = await fetch('/api/cadastro-motorista', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();

            if (data.success) {
              exibirFeedback('Motorista cadastrado com sucesso!', 'success');
              this.reset();
            } else {
              exibirFeedback('Erro: ' + data.message, 'error');
            }
          } catch (error) {
            exibirFeedback('Erro na comunicação com o servidor.', 'error');
          }
        });
      </script>
    <% } %>
  </div>

  <!-- Bootstrap JS e Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
