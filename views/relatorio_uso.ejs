<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório de Uso de Veículos</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <!-- DataTables CSS Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* Remove o overflow horizontal em telas grandes */
    @media (min-width: 1200px) {
      .table-responsive {
        overflow-x: visible !important;
      }
    }
  </style>
</head>

<body class="bg-light">
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h1 class="text-center mb-4">Relatório de Uso de Veículos</h1>
        
        <div class="text-center">
          <a href="/" class="btn btn-secondary mt-4 mb-2">Voltar para a Página Inicial</a>
        </div>

        <div class="mb-3">
          <button id="deleteSelected" class="btn btn-danger">Excluir Selecionados</button>
        </div>

        <div class="table-responsive">
          <table id="usoTable" class="table table-striped table-hover w-100">
            <thead class="table-dark">
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>ID</th> <!-- Coluna adicionada -->
                <th>Veículo</th>
                <th>Motorista</th>
                <th>KM Inicial</th>
                <th>KM Final</th>
                <th>Finalidade</th>
                <th>Descrição</th>
                <th>Data de Início</th>
                <th>Data de Fim</th>
                <th>Data de Criação</th>
                <th>Foto de Quilometragem Final</th>
                <th>Multas</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- Dados carregados via Ajax -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Bootstrap para Exibir Imagem -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Foto de Quilometragem</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" class="img-fluid">
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery (necessário para DataTables) -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function updateModalImage(imgSrc) {
      document.getElementById('modalImage').src = imgSrc;
    }
  
    $(document).ready(function () {
      var table = $('#usoTable').DataTable({
        "serverSide": true,
        "ajax": "/api/relatorio-uso",
        // Agora ordena pela data de criação, que passou a ser a coluna de índice 10
        "order": [[10, "desc"]],
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
        "language": {
          "sEmptyTable": "Nenhum registro encontrado",
          "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
          "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
          "sInfoFiltered": "(Filtrados de _MAX_ registros)",
          "sLengthMenu": "Mostrar _MENU_ registros por página",
          "sLoadingRecords": "Carregando...",
          "sProcessing": "Processando...",
          "sSearch": "Pesquisar:",
          "sZeroRecords": "Nenhum registro encontrado",
          "oPaginate": {
            "sNext": "Próximo",
            "sPrevious": "Anterior",
            "sFirst": "Primeiro",
            "sLast": "Último"
          },
          "oAria": {
            "sSortAscending": ": Ordenar colunas de forma ascendente",
            "sSortDescending": ": Ordenar colunas de forma descendente"
          }
        },
        "columns": [
          { // Coluna do checkbox (não pesquisável)
            "data": "id",
            "orderable": false,
            "searchable": false,
            "render": function (data) {
              return `<input type="checkbox" class="selectRow" value="${data}">`;
            }
          },
          { 
            "data": "id", // Coluna que exibe o ID – agora explicitamente pesquisável
            "searchable": true
          },
          { "data": "placa" },
          { "data": "motorista" },
          { "data": "km_inicial" },
          { "data": "km_final" },
          { "data": "finalidade" },
          { "data": "descricao" },
          {
            "data": "data_hora_inicial",
            "render": function (data) {
              return new Date(data).toLocaleString("pt-BR", {
                day: "2-digit", month: "2-digit", year: "numeric",
                hour: "2-digit", minute: "2-digit", second: "2-digit",
                hour12: false
              });
            }
          },
          {
            "data": "data_hora_final",
            "render": function (data) {
              return data ? new Date(data).toLocaleString("pt-BR", {
                day: "2-digit", month: "2-digit", year: "numeric",
                hour: "2-digit", minute: "2-digit", second: "2-digit",
                hour12: false
              }) : "Não definido";
            }
          },
          {
            "data": "data_criacao",
            "render": function (data) {
              return new Date(data).toLocaleString("pt-BR", {
                day: "2-digit", month: "2-digit", year: "numeric",
                hour: "2-digit", minute: "2-digit", second: "2-digit",
                hour12: false
              });
            }
          },
          {
            "data": "foto_km",
            "orderable": false,
            "searchable": false,
            "render": function (data) {
              return data
                ? `<img src="/uploads/${data}" alt="Foto Quilometragem" class="img-thumbnail img-fluid" style="max-width: 100px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#imageModal" onclick="updateModalImage('/uploads/${data}')">`
                : `<span class="text-muted">Não disponível</span>`;
            }
          },
          {
            "data": "multas",
            "orderable": false,
            "searchable": false,
            "render": function (data, type, row) {
              let html = "";
              if (data) {
                html += `<p class="text-danger">Multas registradas: <span class="badge bg-danger">${data}</span></p>`;
              }
              html += `<!-- Formulário de multa comentado -->`;
              return html;
            }
          },
          {
            "data": "id",
            "orderable": false,
            "searchable": false,
            "render": function (data) {
              return `
                <div class="d-flex gap-2">
                  <a href="/editar-uso/${data}" class="btn btn-warning btn-sm">Editar</a>
                  <form action="/excluir-uso/${data}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este uso?');">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                  </form>
                </div>
              `;
            }
          }
        ]
      });
  
      // Seleciona ou desmarca todos os checkboxes
      $('#selectAll').on('click', function () {
        $('.selectRow').prop('checked', this.checked);
      });
  
      // Ação para excluir os registros selecionados
      $('#deleteSelected').on('click', function () {
        var selectedIds = $('.selectRow:checked').map(function () {
          return this.value;
        }).get();
  
        if (selectedIds.length === 0) {
          alert('Nenhum registro selecionado.');
          return;
        }
  
        if (!confirm('Tem certeza que deseja excluir os registros selecionados?')) {
          return;
        }
  
        $.ajax({
          url: '/excluir-multiplos-usos',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ ids: selectedIds }),
          success: function (response) {
            alert(response.message);
            table.ajax.reload();
          },
          error: function () {
            alert('Erro ao excluir registros.');
          }
        });
      });
    });
  </script>
  
</body>

</html>
