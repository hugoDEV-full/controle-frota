<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="<%= csrfToken %>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Uso e Multas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/styles.css">
  <script>
    // Função para adicionar um novo campo de multa
    function addFineField() {
      var container = document.getElementById('novasMultas');
      var input = document.createElement('input');
      input.type = 'text';
      input.name = 'novasMultas[]';
      input.className = 'form-control mt-2';
      input.placeholder = 'Descrição da nova multa';
      container.appendChild(input);
    }

    // Função para excluir uma multa via criação dinâmica de formulário
    function deleteFine(multaId) {
      if (confirm('Excluir esta multa?')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/excluir-multa/' + multaId;
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
</head>

<body>
  <div class="container mt-4">
    <% if (typeof errorMessage !== 'undefined') { %>
      <div class="alert alert-danger" role="alert">
        <%= errorMessage %>
      </div>
    <% } %>
    
    <h1>Editar Uso e Multas</h1>
    <!-- Formulário para editar uso e multas -->
    <form action="/editar-uso/<%= uso.id %>" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <!-- Dados do Uso -->
      <h3>Dados do Uso</h3>
      <div class="mb-3">
        <label for="motorista" class="form-label">Motorista</label>
        <input type="text" class="form-control" id="motorista" name="motorista" value="<%= uso.motorista %>" required readonly>
      </div>
      <div class="mb-3">
        <label for="km_inicial" class="form-label">KM Inicial</label>
        <input type="number" class="form-control" id="km_inicial" name="km_inicial" value="<%= uso.km_inicial %>"
          readonly>
      </div>
      <div class="mb-3">
        <label for="km_final" class="form-label">KM Final</label>
        <input type="number" class="form-control" id="km_final" name="km_final" value="<%= uso.km_final %>" required>
      </div>
      <div class="mb-3">
        <label for="data_hora_inicial" class="form-label">Data e Hora Inicial</label>
        <input type="datetime-local" class="form-control" id="data_hora_inicial" name="data_hora_inicial"
          value="<%= new Date(uso.data_hora_inicial).toLocaleString('sv-SE', { timeZone: 'America/Sao_Paulo' }).replace(' ', 'T') %>" 
          readonly>
      </div>
      

      <div class="mb-3">
        <label for="data_hora_final" class="form-label">Data e Hora Final</label>
        <% 
          // Se houver registro no banco, usa esse valor; senão, usa a data atual
          let dt = uso.data_hora_final ? new Date(uso.data_hora_final) : new Date();
      
          // fuso de São Paulo
          let options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'America/Sao_Paulo'
          };
      
          // O formato 'sv-SE'  similar a "YYYY-MM-DD HH:mm",
        
          let formatted = dt.toLocaleString('sv-SE', options).replace(' ', 'T');
        %>
        <input type="datetime-local" class="form-control" id="data_hora_final" name="data_hora_final" value="<%= formatted %>">
      </div>
      
      


      <div class="mb-3">
        <label for="foto_km" class="form-label">Foto de Quilometragem final</label>
        <input type="file" class="form-control" id="foto_km" name="foto_km" <%= !uso.foto_km ? 'required' : '' %>>
        <% if (uso.foto_km) { %>
          <p>Imagem atual:</p>
          <img src="/uploads/<%= uso.foto_km %>" alt="Foto Quilometragem" class="img-fluid mt-2" style="max-width: 200px;">
        <% } %>
      </div>
        <!-- Novo campo: Finalidade do Uso -->
        <div class="mb-3">
          <label for="finalidade" class="form-label">Finalidade do Uso</label>
          <select class="form-select" id="finalidade" name="finalidade" required>
            <option value="">Selecione a finalidade...</option>
            <option value="Pessoal" <%= uso.finalidade === 'Pessoal' ? 'selected' : '' %>>Pessoal</option>
            <option value="Trabalho" <%= uso.finalidade === 'Trabalho' ? 'selected' : '' %>>Trabalho</option>
          </select>
        </div>
        
        <!-- Novo campo: Descrição do Uso -->
        <div class="mb-3">
          <label for="descricao" class="form-label">Descrição do Uso</label>
          <textarea class="form-control" id="descricao" name="descricao" rows="3" placeholder="Informe detalhes adicionais, se necessário"><%= uso.descricao || '' %></textarea>
        </div>

      <hr>

      <button type="submit" class="btn btn-primary">Salvar Alterações</button>
      <a href="/relatorio-uso" class="btn btn-secondary">Cancelar</a>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>